<ion-content class="flex-1 relative">
  <picture class="absolute top-0 left-0 w-full h-full pointer-events-none">
    <img [nwImage]="backgroundImage()" class="block w-full h-full object-cover blur-lg" />
  </picture>
  <ion-content class="ion-p-4" [gutterStable]="true">
    <div class="content-grid max-w-screen-3xl mx-auto">
      <div class="content-grid-info flex flex-col gap-2 font-nimbus prose-base">
        <h1 class="mb-0 font-normal font-serif tracking-wider">
          <span>{{ title() | nwText }}</span>
          @if (difficultyLevel()) {
            <span>, Difficulty {{ difficultyLevel() }}</span>
          }
        </h1>
        <div class="nw-item-divider max-w-lg"></div>

        @if (description()) {
          <div class="text-nw-description">
            {{ description() | nwText }}
          </div>
          <div class="nw-item-divider max-w-lg"></div>
        }

        <section class="font-nimbus prose-base">
          @if (requirementText()) {
            <div>
              <span>Requires: </span>
              <span>{{ requirementText() | nwText }}</span>
            </div>
          }
          @if (groupSizeMin()) {
            <div>
              <span>Minimum Players:</span>
              <span class="font-semibold text-accent">
                {{ groupSizeMin() }}
                @if (groupSizeMax()) {
                  - {{ groupSizeMax() }}
                }
              </span>
            </div>
          }
          @if (requiredLevel()) {
            <div>
              <span>Required Level: </span>
              <span class="font-semibold text-accent">{{ requiredLevel() }}</span>
            </div>
          } @else if (recommendedLevel()) {
            <div>
              <span>Recommended Level: </span>
              <span class="font-semibold text-accent">{{ recommendedLevel() }}</span>
            </div>
          }
          @if (requiredGearScore()) {
            <div>
              <span>Required Minimum Gear Score: </span>
              <span class="font-semibold text-accent">{{ requiredGearScore() }}</span>
            </div>
          } @else if (recommendedGsMin()) {
            <div>
              <span>Recommended Gear Score: </span>
              <span class="font-semibold text-accent">
                {{ recommendedGsMin() }}
                @if (recommendedGsMax()) {
                  - {{ recommendedGsMax() }}
                }
              </span>
            </div>
          }
          @if (lootGsRange()) {
            <div>
              <span>Loot Gear Score: </span>
              <span class="font-semibold text-accent">
                {{ lootGsRange() }}
              </span>
            </div>
          }
        </section>

        @if (isMutable()) {
          <div
            role="tablist"
            class="tabs tabs-box bg-base-200/50 backdrop-blur-2xl"
            animate.enter="fade-enter" animate.leave="fade-leave"
          >
            <a
              role="tab"
              rel="nofollow"
              [routerLink]="['.']"
              [queryParams]="{}"
              class="tab"
              [class.tab-active]="!difficulty()"
              [class.text-primary]="!difficulty()"
            >
              Regular
            </a>

            @for (item of difficulties(); track $index) {
              <a
                rel="nofollow"
                role="tab"
                class="tab"
                [routerLink]="['.']"
                [queryParams]="{ difficulty: item.MutationDifficulty }"
                [queryParamsHandling]="'merge'"
                [class.tab-active]="item.MutationDifficulty == paramDifficulty()"
                [class.text-primary]="item.MutationDifficulty == paramDifficulty()"
              >
                <!-- <img [nwImage]="difficultyRankIcon(dungeon, item) | async" class="w-8 h-8" /> -->
                Mutation {{ item.MutationDifficulty }}
              </a>
            }
          </div>
        }
        @if (difficulty()) {
          <div animate.enter="fade-enter" animate.leave="fade-leave">
            <h2 class="mb-0 mt-4 font-normal font-serif tracking-wider uppercase flex flex-row items-center gap-2">
              <span>Mutation </span>
              @if (activeMutation()) {
                <picture class="inline-block w-8 mt-0 mb-0 animate-pulse">
                  <img
                    [nwImage]="'assets/icons/expedition/mutated_dungeon_active.png'"
                    class="w-full aspect-square rounded-full animate-spin-cw"
                  />
                </picture>
                <span>Active </span>
              }
            </h2>
            <div class="nw-item-divider max-w-lg mb-2"></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 max-w-3xl items-start">
              @if (store.mutaElementAvailable()) {
                <nwb-muta-element-tile
                  [mutaElement]="store.mutaElement()"
                  (mutaElementChanged)="onMutaElementSelected($event)"
                  [options]="store.mutaElementOptions()"
                  animate.enter="fade-slide-up-enter"
                  animate.leave="fade-slide-up-leave"
                />
              }
              @if (store.mutaPromotionAvailable()) {
                <nwb-muta-promotion-tile
                  [mutaPromotion]="store.mutaPromotion()"
                  [mutaElement]="store.mutaElement()"
                  (mutaPromotionChanged)="onMutaPromotionSelected($event)"
                  [options]="store.mutaPromotionOptions()"
                  animate.enter="fade-slide-up-enter"
                  animate.leave="fade-slide-up-leave"
                />
              }
              @if (store.mutaCurseAvailable()) {
                <nwb-muta-curse-tile
                  [mutaCurse]="store.mutaCurse()"
                  [mutaElement]="store.mutaElement()"
                  (mutaCurseChanged)="onMutaCurseSelected($event)"
                  [options]="store.mutaCurseOptions()"
                  animate.enter="fade-slide-up-enter"
                  animate.leave="fade-slide-up-leave"
                />
              }
            </div>
          </div>
        }

        @if (store.possibleItemDropIds()?.length) {
          <h2 class="mb-0 mt-4 font-normal font-serif tracking-wider uppercase">
            <span>Available Rewards </span>
          </h2>
          <div class="nw-item-divider max-w-lg"></div>

          <div class="w-full max-h-[500px] overflow-auto bg-neutral/50 rounded-sm p-2">
            <div class="flex flex-row flex-wrap gap-2">
              @for (itemId of store.possibleItemDropIds(); track $index; let index = $index) {
                <a
                  [nwLinkTooltip]="['item', itemId]"
                  [nwbItemDetail]="itemId"
                  #detail="itemDetail"
                  class="block w-full max-w-[60px] aspect-square"
                >
                  <picture [nwIcon]="detail.item()" class="block w-full h-full my-0 mt-0 mb-0"></picture>
                </a>
              }
            </div>
          </div>
        }
        <!-- @if (difficulty()) {
          <div class="stats bg-opacity-0 self-end w-full">
            @for (row of difficyltyRewards$ | async; track $index) {
              <div class="stat place-items-center p-0">
                <div class="stat-title">
                  <span [nwText]="row.RankName"></span>
                </div>
                <div
                  class="stat-value cursor-pointer transition-all rounded-md outline-4 outline-transparent focus:outline-primary hover:outline-primary"
                  [class.text-primary]="row.Completed"
                  (click)="row.toggle()"
                >
                  {{ row.Quantity }}
                </div>
                <div class="stat-desc">
                  <span [nwText]="row.ItemName"></span>
                </div>
              </div>
            }
          </div>
        } -->
      </div>

      <div class="content-grid-tabs tabs tabs-border flex-nowrap justify-stretch flex-none self-end">
        @for (item of tabs(); track item.id) {
          <a
            class="tab"
            [class.tab-active]="item.active"
            [class.opacity-25]="!item.count"
            [routerLink]="['.']"
            [queryParams]="{ tab: item.id }"
            [queryParamsHandling]="'merge'"
            rel="nofollow"
          >
            {{ item.label }}
          </a>
        }
      </div>

      <div
        class="content-grid-map flex justify-end aspect-square md:aspect-video 3xl:aspect-auto 3xl:min-h-[500px] z-50"
        [class.sticky]="mapPinned()"
        [class.top-0]="mapPinned()"
        [class.right-0]="mapPinned()"
        [class.max-h-[35vh]]="mapPinned()"
      >
        <nwb-game-mode-detail-map
          class="w-full h-full max-w-[1200px] max-h-[800px] group"
          [gameModeId]="paramGameMode()"
          [creatures]="store.creatures()"
          [highlight]="(vitalTargetHover() || vitalTargetClick())?.VitalsID"
          [class.bg-base-300]="mapPinned()"
        >
          <div class="inline-flex absolute top-0 right-0">
            <button
              class="btn btn-sm btn-ghost btn-square opacity-0 group-hover:opacity-100"
              [class.text-primary]="mapPinned()"
              (click)="mapPinned.set(!mapPinned())"
            >
              <nwb-icon [icon]="iconPin" class="w-5 h-5" />
            </button>
          </div>
        </nwb-game-mode-detail-map>
      </div>

      <div class="content-grid-content">
        @for (tab of tabs(); track tab.id) {
          @if (tab.active && tab.loot?.length) {
            <nwb-game-mode-detail-loot [items]="tab.loot" animate.leave="fade-leave" />
          }
          @if (tab.active && tab.vitals?.length) {
            <nwb-game-mode-detail-vitals
              [items]="tab.vitals"
              [selectedVital]="vitalTargetClick()"
              [activeTab]="paramTabVitals()"
              (activeTabChange)="handleVitalTabChange($event)"
              (vitalTargetEnter)="handleVitalTargetEnter($event)"
              (vitalTargetLeave)="handleVitalTargetLeave($event)"
              (vitalTargetClick)="handleVitalTargetClick($event)"
              animate.leave="fade-slide-up-leave"
            />
          }
        }
      </div>
    </div>
  </ion-content>
</ion-content>

<!-- <ng-template #tplExplain>
  <ion-header>
    <ion-toolbar class="ion-color ion-color-black border border-base-100 border-b-0 rounded-t-md">
      <ion-title>Loot Graph</ion-title>
      <button type="button" slot="end" class="btn btn-ghost btn-circle mr-2 text-xl" [nwbModalClose]>&times;</button>
    </ion-toolbar>
  </ion-header>
  <ion-content class="rounded-b-md bg-base-100">
    @if (explainVm$ | async; as vm) {
      <nwb-loot-graph [tags]="vm.tags" [tagValues]="vm.values" [tableId]="vm.tableIds" [highlight]="vm.itemId" />
    }
  </ion-content>
</ng-template> -->

<!-- <ng-template #tplExplainMenu>
  <ul class="menu menu-compact bg-base-100 rounded-md w-40" cdkMenu>
    <li>
      <button [nwbModalOpen]="{ content: tplExplain, size: 'md' }" cdkMenuItem>Explain Drop</button>
    </li>
  </ul>
</ng-template> -->
